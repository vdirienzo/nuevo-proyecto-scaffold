import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../../../core/constants/api_constants.dart';
import '../../../core/network/api_client.dart';
import '../domain/auth_model.dart';
import 'auth_local_storage.dart';

final authRepositoryProvider = Provider<AuthRepository>((ref) {
  return AuthRepository(
    apiClient: ref.watch(apiClientProvider),
    localStorage: ref.watch(authLocalStorageProvider),
  );
});

class AuthRepository {
  final ApiClient _apiClient;
  final AuthLocalStorage _localStorage;

  AuthRepository({
    required ApiClient apiClient,
    required AuthLocalStorage localStorage,
  })  : _apiClient = apiClient,
        _localStorage = localStorage;

  Future<AuthResponse> login(LoginRequest request) async {
    final response = await _apiClient.post<Map<String, dynamic>>(
      ApiConstants.login,
      data: request.toJson(),
    );

    final authResponse = AuthResponse.fromJson(response.data!);

    await _localStorage.saveAccessToken(authResponse.tokens.accessToken);
    await _localStorage.saveRefreshToken(authResponse.tokens.refreshToken);
    await _localStorage.saveUserId(authResponse.user.id);

    return authResponse;
  }

  Future<AuthResponse> register(RegisterRequest request) async {
    final response = await _apiClient.post<Map<String, dynamic>>(
      ApiConstants.register,
      data: request.toJson(),
    );

    final authResponse = AuthResponse.fromJson(response.data!);

    await _localStorage.saveAccessToken(authResponse.tokens.accessToken);
    await _localStorage.saveRefreshToken(authResponse.tokens.refreshToken);
    await _localStorage.saveUserId(authResponse.user.id);

    return authResponse;
  }

  Future<void> logout() async {
    try {
      await _apiClient.post(ApiConstants.logout);
    } finally {
      await _localStorage.clearAll();
    }
  }

  Future<User> getCurrentUser() async {
    final response = await _apiClient.get<Map<String, dynamic>>(
      ApiConstants.me,
    );

    return User.fromJson(response.data!);
  }

  Future<bool> isAuthenticated() async {
    return await _localStorage.hasAccessToken();
  }

  Future<AuthResponse> refreshToken() async {
    final refreshToken = await _localStorage.getRefreshToken();

    if (refreshToken == null) {
      throw Exception('No refresh token available');
    }

    final response = await _apiClient.post<Map<String, dynamic>>(
      ApiConstants.refreshToken,
      data: {'refreshToken': refreshToken},
    );

    final authResponse = AuthResponse.fromJson(response.data!);

    await _localStorage.saveAccessToken(authResponse.tokens.accessToken);
    await _localStorage.saveRefreshToken(authResponse.tokens.refreshToken);

    return authResponse;
  }
}
