import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../core/constants/app_constants.dart';
import '../../../core/router/routes.dart';
import '../../../core/utils/extensions.dart';
import '../../auth/providers/auth_provider.dart';
import '../../../shared/widgets/app_button.dart';
import '../../../shared/widgets/app_card.dart';

class ProfileScreen extends ConsumerWidget {
  const ProfileScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final authState = ref.watch(authProvider);
    final user = authState.user;

    return Scaffold(
      appBar: AppBar(
        title: const Text('Profile'),
      ),
      body: authState.isLoading
          ? const Center(child: CircularProgressIndicator())
          : ListView(
              padding: const EdgeInsets.all(AppConstants.defaultPadding),
              children: [
                AppCard(
                  child: Padding(
                    padding: const EdgeInsets.all(AppConstants.defaultPadding),
                    child: Column(
                      children: [
                        CircleAvatar(
                          radius: 50,
                          backgroundColor: context.colorScheme.primaryContainer,
                          child: user?.avatarUrl != null
                              ? ClipOval(
                                  child: Image.network(
                                    user!.avatarUrl!,
                                    fit: BoxFit.cover,
                                    width: 100,
                                    height: 100,
                                    errorBuilder: (context, error, stackTrace) {
                                      return _buildAvatarPlaceholder(
                                        context,
                                        user,
                                      );
                                    },
                                  ),
                                )
                              : _buildAvatarPlaceholder(context, user),
                        ),
                        const SizedBox(height: AppConstants.defaultPadding),
                        Text(
                          user?.username ?? 'Unknown User',
                          style: context.textTheme.headlineSmall?.copyWith(
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        if (user?.email != null) ...[
                          const SizedBox(height: AppConstants.defaultPadding / 4),
                          Text(
                            user!.email,
                            style: context.textTheme.bodyMedium?.copyWith(
                              color: context.colorScheme.onSurfaceVariant,
                            ),
                          ),
                        ],
                        if (user?.isVerified ?? false) ...[
                          const SizedBox(height: AppConstants.defaultPadding / 2),
                          Chip(
                            label: const Text('Verified'),
                            avatar: const Icon(Icons.verified, size: 16),
                            backgroundColor:
                                context.colorScheme.primaryContainer,
                          ),
                        ],
                      ],
                    ),
                  ),
                ),
                const SizedBox(height: AppConstants.defaultPadding * 2),
                AppCard(
                  child: Column(
                    children: [
                      _buildInfoTile(
                        context: context,
                        icon: Icons.person_outline,
                        label: 'Full Name',
                        value: user?.firstName != null || user?.lastName != null
                            ? '${user?.firstName ?? ''} ${user?.lastName ?? ''}'
                                .trim()
                            : 'Not set',
                      ),
                      const Divider(height: 1),
                      _buildInfoTile(
                        context: context,
                        icon: Icons.calendar_today,
                        label: 'Member Since',
                        value: user?.createdAt.toFormattedString() ?? 'Unknown',
                      ),
                    ],
                  ),
                ),
                const SizedBox(height: AppConstants.defaultPadding * 2),
                AppButton(
                  onPressed: () => _handleLogout(context, ref),
                  text: 'Logout',
                  backgroundColor: context.colorScheme.error,
                  foregroundColor: context.colorScheme.onError,
                  icon: Icons.logout,
                ),
              ],
            ),
    );
  }

  Widget _buildAvatarPlaceholder(BuildContext context, dynamic user) {
    return Icon(
      Icons.person,
      size: 50,
      color: context.colorScheme.onPrimaryContainer,
    );
  }

  Widget _buildInfoTile({
    required BuildContext context,
    required IconData icon,
    required String label,
    required String value,
  }) {
    return ListTile(
      leading: Icon(icon, color: context.colorScheme.primary),
      title: Text(label),
      subtitle: Text(value),
    );
  }

  Future<void> _handleLogout(BuildContext context, WidgetRef ref) async {
    final confirmed = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Logout'),
        content: const Text('Are you sure you want to logout?'),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(false),
            child: const Text('Cancel'),
          ),
          TextButton(
            onPressed: () => Navigator.of(context).pop(true),
            child: const Text('Logout'),
          ),
        ],
      ),
    );

    if (confirmed == true && context.mounted) {
      try {
        await ref.read(authProvider.notifier).logout();
        if (context.mounted) {
          context.go(Routes.login);
        }
      } catch (e) {
        if (context.mounted) {
          context.showErrorSnackbar('Failed to logout: $e');
        }
      }
    }
  }
}
