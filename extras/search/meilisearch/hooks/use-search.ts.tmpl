/**
 * React Search Hook
 *
 * Author: {{AUTHOR}}
 * Project: {{PROJECT_NAME}}
 */

'use client';

import { useState, useEffect } from 'react';
import { useDebounce } from '@/hooks/use-debounce';

interface SearchResult<T> {
  hits: T[];
  total: number;
  query: string;
  processingTimeMs: number;
}

interface UseSearchOptions {
  debounceMs?: number;
  limit?: number;
  filters?: string[];
}

export function useSearch<T>(
  indexName: string,
  initialQuery: string = '',
  options: UseSearchOptions = {}
) {
  const { debounceMs = 300, limit = 20, filters = [] } = options;

  const [query, setQuery] = useState(initialQuery);
  const [results, setResults] = useState<SearchResult<T> | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<Error | null>(null);

  const debouncedQuery = useDebounce(query, debounceMs);

  useEffect(() => {
    if (!debouncedQuery.trim()) {
      setResults(null);
      return;
    }

    const performSearch = async () => {
      setIsLoading(true);
      setError(null);

      try {
        const response = await fetch('/api/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            indexName,
            query: debouncedQuery,
            limit,
            filters,
          }),
        });

        if (!response.ok) {
          throw new Error('Search failed');
        }

        const data = await response.json();
        setResults(data);
      } catch (err) {
        setError(err instanceof Error ? err : new Error('Unknown error'));
      } finally {
        setIsLoading(false);
      }
    };

    performSearch();
  }, [debouncedQuery, indexName, limit, JSON.stringify(filters)]);

  return {
    query,
    setQuery,
    results,
    isLoading,
    error,
    hasResults: results !== null && results.hits.length > 0,
  };
}
