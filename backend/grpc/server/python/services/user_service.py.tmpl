"""
user_service.py.tmpl - User service implementation

Author: {{AUTHOR}}
Project: {{PROJECT_NAME}}
"""

import logging
from datetime import datetime
from typing import Optional

import grpc

# Generated protobuf imports (adjust paths based on your generation)
# from gen.user.v1 import user_pb2, user_pb2_grpc
# from gen.common.v1 import common_pb2


logger = logging.getLogger(__name__)


class UserService:
    """User service implementation."""

    def __init__(self, database_url: str):
        self.database_url = database_url
        logger.info("UserService initialized")

    async def GetUser(self, request, context):
        """Get a single user by ID."""
        if not request.id:
            context.set_code(grpc.StatusCode.INVALID_ARGUMENT)
            context.set_details("user id is required")
            return

        # TODO: Fetch from database
        logger.info(f"GetUser called with id={request.id}")

        # TODO: Return actual user_pb2.GetUserResponse
        # return user_pb2.GetUserResponse(
        #     user=user_pb2.User(
        #         id=request.id,
        #         email="user@example.com",
        #         username="exampleuser",
        #         full_name="Example User",
        #         is_active=True,
        #         roles=["user"],
        #     )
        # )

    async def ListUsers(self, request, context):
        """List users with pagination and filters."""
        page = request.pagination.page if request.pagination.page > 0 else 1
        per_page = request.pagination.per_page if request.pagination.per_page > 0 else 20

        logger.info(f"ListUsers called with page={page}, per_page={per_page}")

        # TODO: Fetch from database with pagination
        # users = []
        # total = 0
        # total_pages = (total + per_page - 1) // per_page

        # return user_pb2.ListUsersResponse(
        #     users=users,
        #     pagination=common_pb2.PaginationResponse(
        #         page=page,
        #         per_page=per_page,
        #         total=total,
        #         total_pages=total_pages,
        #         has_next=page < total_pages,
        #         has_prev=page > 1,
        #     )
        # )

    async def CreateUser(self, request, context):
        """Create a new user."""
        if not request.email:
            context.set_code(grpc.StatusCode.INVALID_ARGUMENT)
            context.set_details("email is required")
            return

        if not request.username:
            context.set_code(grpc.StatusCode.INVALID_ARGUMENT)
            context.set_details("username is required")
            return

        if not request.password:
            context.set_code(grpc.StatusCode.INVALID_ARGUMENT)
            context.set_details("password is required")
            return

        logger.info(f"CreateUser called for email={request.email}")

        # TODO: Hash password and save to database
        # return user_pb2.CreateUserResponse(
        #     user=user_pb2.User(
        #         id="generated-id",
        #         email=request.email,
        #         username=request.username,
        #         full_name=request.full_name,
        #         is_active=True,
        #         roles=["user"],
        #     )
        # )

    async def UpdateUser(self, request, context):
        """Update an existing user."""
        if not request.id:
            context.set_code(grpc.StatusCode.INVALID_ARGUMENT)
            context.set_details("user id is required")
            return

        logger.info(f"UpdateUser called for id={request.id}")

        # TODO: Update in database
        # return user_pb2.UpdateUserResponse(
        #     user=user_pb2.User(
        #         id=request.id,
        #         email=request.email if request.HasField("email") else None,
        #         username=request.username if request.HasField("username") else None,
        #     )
        # )

    async def DeleteUser(self, request, context):
        """Delete a user."""
        if not request.id:
            context.set_code(grpc.StatusCode.INVALID_ARGUMENT)
            context.set_details("user id is required")
            return

        logger.info(f"DeleteUser called for id={request.id}")

        # TODO: Delete from database
        # return user_pb2.DeleteUserResponse(success=True)

    async def StreamUsers(self, request, context):
        """Stream users matching the filter."""
        logger.info("StreamUsers called")

        # TODO: Stream users from database
        # users = []  # Fetch from database
        # for user in users:
        #     yield user
