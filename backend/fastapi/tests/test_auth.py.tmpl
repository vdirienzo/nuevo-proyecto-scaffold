# tests/test_auth.py - Authentication Tests
# Author: {{AUTHOR}}
# Project: {{PROJECT_NAME}}

"""
Tests for authentication endpoints.
"""

from typing import Any

import pytest
from httpx import AsyncClient

from src.{{PROJECT_NAME_SNAKE}}.models import User


class TestRegister:
    """Tests for user registration endpoint."""

    @pytest.mark.asyncio
    async def test_register_success(
        self,
        client: AsyncClient,
        user_data: dict[str, Any],
    ):
        """Test successful user registration."""
        # Act
        response = await client.post("/auth/register", json=user_data)

        # Assert
        assert response.status_code == 201
        data = response.json()
        assert data["email"] == user_data["email"]
        assert data["username"] == user_data["username"]
        assert "id" in data
        assert "hashed_password" not in data  # Security: no password in response

    @pytest.mark.asyncio
    async def test_register_duplicate_email_fails(
        self,
        client: AsyncClient,
        test_user: User,
        user_data: dict[str, Any],
    ):
        """Test that registering with existing email fails."""
        # Act
        response = await client.post("/auth/register", json=user_data)

        # Assert
        assert response.status_code == 409
        assert "email" in response.json()["details"]["field"]

    @pytest.mark.asyncio
    async def test_register_weak_password_fails(self, client: AsyncClient):
        """Test that weak passwords are rejected."""
        # Arrange
        data = {
            "email": "new@example.com",
            "username": "newuser",
            "password": "weak",  # Too short, no complexity
        }

        # Act
        response = await client.post("/auth/register", json=data)

        # Assert
        assert response.status_code == 422


class TestLogin:
    """Tests for login endpoint."""

    @pytest.mark.asyncio
    async def test_login_with_email_success(
        self,
        client: AsyncClient,
        test_user: User,
        user_data: dict[str, Any],
    ):
        """Test successful login with email."""
        # Arrange
        form_data = {
            "username": user_data["email"],
            "password": user_data["password"],
        }

        # Act
        response = await client.post(
            "/auth/login",
            data=form_data,
            headers={"Content-Type": "application/x-www-form-urlencoded"},
        )

        # Assert
        assert response.status_code == 200
        data = response.json()
        assert "access_token" in data
        assert "refresh_token" in data
        assert data["token_type"] == "bearer"

    @pytest.mark.asyncio
    async def test_login_with_username_success(
        self,
        client: AsyncClient,
        test_user: User,
        user_data: dict[str, Any],
    ):
        """Test successful login with username."""
        # Arrange
        form_data = {
            "username": user_data["username"],
            "password": user_data["password"],
        }

        # Act
        response = await client.post(
            "/auth/login",
            data=form_data,
            headers={"Content-Type": "application/x-www-form-urlencoded"},
        )

        # Assert
        assert response.status_code == 200

    @pytest.mark.asyncio
    async def test_login_invalid_password_fails(
        self,
        client: AsyncClient,
        test_user: User,
        user_data: dict[str, Any],
    ):
        """Test that wrong password fails."""
        # Arrange
        form_data = {
            "username": user_data["email"],
            "password": "WrongPassword123!",
        }

        # Act
        response = await client.post(
            "/auth/login",
            data=form_data,
            headers={"Content-Type": "application/x-www-form-urlencoded"},
        )

        # Assert
        assert response.status_code == 401

    @pytest.mark.asyncio
    async def test_login_nonexistent_user_fails(self, client: AsyncClient):
        """Test that login with non-existent user fails."""
        # Arrange
        form_data = {
            "username": "nonexistent@example.com",
            "password": "SomePassword123!",
        }

        # Act
        response = await client.post(
            "/auth/login",
            data=form_data,
            headers={"Content-Type": "application/x-www-form-urlencoded"},
        )

        # Assert
        assert response.status_code == 401


class TestRefreshToken:
    """Tests for token refresh endpoint."""

    @pytest.mark.asyncio
    async def test_refresh_token_success(
        self,
        client: AsyncClient,
        test_user: User,
        user_data: dict[str, Any],
    ):
        """Test successful token refresh."""
        # Arrange - First login to get tokens
        login_response = await client.post(
            "/auth/login",
            data={
                "username": user_data["email"],
                "password": user_data["password"],
            },
            headers={"Content-Type": "application/x-www-form-urlencoded"},
        )
        refresh_token = login_response.json()["refresh_token"]

        # Act
        response = await client.post(
            "/auth/refresh",
            json={"refresh_token": refresh_token},
        )

        # Assert
        assert response.status_code == 200
        data = response.json()
        assert "access_token" in data
        assert "refresh_token" in data

    @pytest.mark.asyncio
    async def test_refresh_with_invalid_token_fails(self, client: AsyncClient):
        """Test that invalid refresh token fails."""
        # Act
        response = await client.post(
            "/auth/refresh",
            json={"refresh_token": "invalid.token.here"},
        )

        # Assert
        assert response.status_code == 401
