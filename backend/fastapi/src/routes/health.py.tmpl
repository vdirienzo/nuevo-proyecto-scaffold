# routes/health.py - Health Check Endpoints
# Author: {{AUTHOR}}
# Project: {{PROJECT_NAME}}

"""
Health check endpoints for Kubernetes probes and monitoring.
"""

from datetime import datetime, timezone

from fastapi import APIRouter, status
from pydantic import BaseModel
from sqlmodel import text

from ..database import get_session


router = APIRouter()


class HealthResponse(BaseModel):
    """Health check response schema."""

    status: str
    timestamp: datetime
    version: str
    checks: dict[str, str]


@router.get(
    "/health",
    response_model=HealthResponse,
    status_code=status.HTTP_200_OK,
    summary="Health check",
    description="Returns the health status of the API and its dependencies.",
)
async def health_check() -> HealthResponse:
    """
    Health check endpoint for load balancers and Kubernetes probes.

    Returns:
        HealthResponse: Current health status of all components.
    """
    checks: dict[str, str] = {}

    # Check database connectivity
    try:
        async for session in get_session():
            await session.execute(text("SELECT 1"))
            checks["database"] = "healthy"
    except Exception:
        checks["database"] = "unhealthy"

    # Determine overall status
    overall_status = "healthy" if all(v == "healthy" for v in checks.values()) else "degraded"

    return HealthResponse(
        status=overall_status,
        timestamp=datetime.now(timezone.utc),
        version="0.1.0",
        checks=checks,
    )


@router.get(
    "/ready",
    status_code=status.HTTP_200_OK,
    summary="Readiness probe",
    description="Kubernetes readiness probe - returns 200 if ready to receive traffic.",
)
async def readiness_probe() -> dict[str, str]:
    """Kubernetes readiness probe."""
    return {"status": "ready"}


@router.get(
    "/live",
    status_code=status.HTTP_200_OK,
    summary="Liveness probe",
    description="Kubernetes liveness probe - returns 200 if the process is alive.",
)
async def liveness_probe() -> dict[str, str]:
    """Kubernetes liveness probe."""
    return {"status": "alive"}
