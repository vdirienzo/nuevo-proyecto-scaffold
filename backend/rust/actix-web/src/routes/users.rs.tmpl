/*!
 * User routes
 *
 * Author: {{AUTHOR}}
 */

use actix_web::{get, put, web, HttpResponse};
use uuid::Uuid;
use validator::Validate;

use crate::{
    db::Database,
    error::AppError,
    models::user::{UpdateUserRequest, UserResponse},
    services::user_service::UserService,
};

#[utoipa::path(
    get,
    path = "/api/v1/users",
    tag = "users",
    responses(
        (status = 200, description = "List of users", body = Vec<UserResponse>)
    )
)]
#[get("")]
pub async fn get_users(db: web::Data<Database>) -> Result<HttpResponse, AppError> {
    let users = UserService::get_all(db.pool()).await?;
    Ok(HttpResponse::Ok().json(users))
}

#[utoipa::path(
    get,
    path = "/api/v1/users/{id}",
    tag = "users",
    params(
        ("id" = Uuid, Path, description = "User ID")
    ),
    responses(
        (status = 200, description = "User found", body = UserResponse),
        (status = 404, description = "User not found")
    )
)]
#[get("/{id}")]
pub async fn get_user(
    db: web::Data<Database>,
    id: web::Path<Uuid>,
) -> Result<HttpResponse, AppError> {
    let user = UserService::get_by_id(db.pool(), *id).await?;
    Ok(HttpResponse::Ok().json(user))
}

#[utoipa::path(
    put,
    path = "/api/v1/users/{id}",
    tag = "users",
    params(
        ("id" = Uuid, Path, description = "User ID")
    ),
    request_body = UpdateUserRequest,
    responses(
        (status = 200, description = "User updated", body = UserResponse),
        (status = 400, description = "Validation error"),
        (status = 404, description = "User not found")
    )
)]
#[put("/{id}")]
pub async fn update_user(
    db: web::Data<Database>,
    id: web::Path<Uuid>,
    request: web::Json<UpdateUserRequest>,
) -> Result<HttpResponse, AppError> {
    request.validate().map_err(|e| AppError::Validation(e.to_string()))?;

    let user = UserService::update(db.pool(), *id, request.into_inner()).await?;
    Ok(HttpResponse::Ok().json(user))
}
