/*!
 * Authentication middleware
 *
 * Author: {{AUTHOR}}
 */

use actix_web::{dev::ServiceRequest, Error, HttpMessage};
use actix_web_httpauth::extractors::bearer::BearerAuth;
use uuid::Uuid;

use crate::{config::Config, error::AppError, services::auth_service::AuthService};

pub async fn validator(
    req: ServiceRequest,
    credentials: BearerAuth,
) -> Result<ServiceRequest, (Error, ServiceRequest)> {
    let config = req
        .app_data::<actix_web::web::Data<Config>>()
        .expect("Config not found");

    match AuthService::verify_token(credentials.token(), &config.jwt) {
        Ok(claims) => {
            let user_id = Uuid::parse_str(&claims.sub)
                .map_err(|_| (AppError::Authentication("Invalid user ID".to_string()).into(), req))?;
            req.extensions_mut().insert(user_id);
            Ok(req)
        }
        Err(e) => Err((e.into(), req)),
    }
}
