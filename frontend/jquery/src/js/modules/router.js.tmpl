/**
 * router.js - Simple hash-based router
 * @author {{AUTHOR}}
 * @project {{PROJECT_NAME}}
 */

import $ from 'jquery';
import { auth } from './auth.js';
import { devLog } from '../config.js';

/**
 * Router class for SPA navigation
 */
class Router {
    constructor() {
        this.routes = new Map();
        this.currentRoute = null;
        this.beforeHooks = [];
        this.afterHooks = [];
    }

    /**
     * Initialize router
     */
    init() {
        // Listen to hash changes
        $(window).on('hashchange', () => {
            const hash = window.location.hash.slice(1);
            this.navigate(hash);
        });

        // Register default routes
        this.registerDefaultRoutes();
    }

    /**
     * Register a route
     * @param {string} path - Route path
     * @param {Function} handler - Route handler function
     * @param {object} options - Route options
     */
    register(path, handler, options = {}) {
        this.routes.set(path, {
            handler,
            requiresAuth: options.requiresAuth !== false,
            title: options.title || 'Page'
        });

        devLog('Route registered:', path);
    }

    /**
     * Register default routes
     */
    registerDefaultRoutes() {
        // Import page modules dynamically
        this.register('login', async () => {
            const { LoginPage } = await import('../pages/login.js');
            const page = new LoginPage();
            await page.render();
        }, { requiresAuth: false, title: 'Login' });

        this.register('dashboard', async () => {
            const { DashboardPage } = await import('../pages/dashboard.js');
            const page = new DashboardPage();
            await page.render();
        }, { title: 'Dashboard' });

        this.register('home', async () => {
            const { HomePage } = await import('../pages/home.js');
            const page = new HomePage();
            await page.render();
        }, { title: 'Home' });

        // Default route
        this.register('', async () => {
            if (auth.isAuthenticated()) {
                this.navigate('dashboard');
            } else {
                this.navigate('login');
            }
        }, { requiresAuth: false });
    }

    /**
     * Navigate to route
     * @param {string} path - Route path
     * @param {object} params - Route parameters
     */
    async navigate(path, params = {}) {
        const route = this.routes.get(path);

        if (!route) {
            console.error('Route not found:', path);
            this.navigate('dashboard');
            return;
        }

        // Check authentication
        if (route.requiresAuth && !auth.isAuthenticated()) {
            devLog('Route requires authentication, redirecting to login');
            window.location.hash = 'login';
            return;
        }

        // Don't navigate to login if already authenticated
        if (path === 'login' && auth.isAuthenticated()) {
            this.navigate('dashboard');
            return;
        }

        try {
            // Run before hooks
            for (const hook of this.beforeHooks) {
                await hook(path, params);
            }

            devLog('Navigating to:', path);

            // Update current route
            this.currentRoute = path;

            // Update document title
            document.title = `${route.title} - {{PROJECT_NAME}}`;

            // Update hash without triggering hashchange
            if (window.location.hash.slice(1) !== path) {
                window.location.hash = path;
            }

            // Show loading
            this.showLoading();

            // Execute route handler
            await route.handler(params);

            // Hide loading
            this.hideLoading();

            // Run after hooks
            for (const hook of this.afterHooks) {
                await hook(path, params);
            }

        } catch (error) {
            console.error('Navigation error:', error);
            this.hideLoading();
        }
    }

    /**
     * Add before navigation hook
     * @param {Function} hook - Hook function
     */
    beforeEach(hook) {
        this.beforeHooks.push(hook);
    }

    /**
     * Add after navigation hook
     * @param {Function} hook - Hook function
     */
    afterEach(hook) {
        this.afterHooks.push(hook);
    }

    /**
     * Get current route
     * @returns {string}
     */
    getCurrentRoute() {
        return this.currentRoute;
    }

    /**
     * Go back
     */
    back() {
        window.history.back();
    }

    /**
     * Show loading indicator
     */
    showLoading() {
        $('#main-content').addClass('loading');
    }

    /**
     * Hide loading indicator
     */
    hideLoading() {
        $('#main-content').removeClass('loading');
    }
}

// Create and export singleton instance
export const router = new Router();

export default router;
