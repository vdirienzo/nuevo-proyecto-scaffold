/**
 * users.js - User management module
 * @author {{AUTHOR}}
 * @project {{PROJECT_NAME}}
 */

import { api } from '../api.js';
import { config } from '../config.js';
import { notifications } from './notifications.js';

/**
 * User management module
 */
class Users {
    constructor() {
        this.cache = new Map();
        this.cacheTimeout = 5 * 60 * 1000; // 5 minutes
    }

    /**
     * Get all users with pagination
     * @param {object} params - Query parameters
     * @returns {Promise<object>} Users list with pagination
     */
    async list(params = {}) {
        try {
            const defaultParams = {
                page: 1,
                per_page: 20,
                sort: 'created_at',
                order: 'desc'
            };

            const queryParams = { ...defaultParams, ...params };
            const data = await api.get(config.endpoints.users.list, {
                params: queryParams
            });

            return data;

        } catch (error) {
            notifications.error('Failed to load users');
            throw error;
        }
    }

    /**
     * Get user by ID
     * @param {number} id - User ID
     * @param {boolean} useCache - Use cached data if available
     * @returns {Promise<object>} User object
     */
    async get(id, useCache = true) {
        // Check cache
        if (useCache && this.cache.has(id)) {
            const cached = this.cache.get(id);
            if (Date.now() - cached.timestamp < this.cacheTimeout) {
                return cached.data;
            }
        }

        try {
            const data = await api.get(config.endpoints.users.get(id));

            // Update cache
            this.cache.set(id, {
                data,
                timestamp: Date.now()
            });

            return data;

        } catch (error) {
            notifications.error('Failed to load user');
            throw error;
        }
    }

    /**
     * Create new user
     * @param {object} userData - User data
     * @returns {Promise<object>} Created user
     */
    async create(userData) {
        try {
            const data = await api.post(config.endpoints.users.create, userData);
            notifications.success('User created successfully');
            return data;

        } catch (error) {
            notifications.error('Failed to create user');
            throw error;
        }
    }

    /**
     * Update user
     * @param {number} id - User ID
     * @param {object} userData - Updated user data
     * @returns {Promise<object>} Updated user
     */
    async update(id, userData) {
        try {
            const data = await api.put(config.endpoints.users.update(id), userData);

            // Invalidate cache
            this.cache.delete(id);

            notifications.success('User updated successfully');
            return data;

        } catch (error) {
            notifications.error('Failed to update user');
            throw error;
        }
    }

    /**
     * Delete user
     * @param {number} id - User ID
     * @returns {Promise<void>}
     */
    async delete(id) {
        try {
            await api.delete(config.endpoints.users.delete(id));

            // Invalidate cache
            this.cache.delete(id);

            notifications.success('User deleted successfully');

        } catch (error) {
            notifications.error('Failed to delete user');
            throw error;
        }
    }

    /**
     * Search users
     * @param {string} query - Search query
     * @param {object} params - Additional parameters
     * @returns {Promise<object>} Search results
     */
    async search(query, params = {}) {
        try {
            const data = await api.get(config.endpoints.users.list, {
                params: {
                    q: query,
                    ...params
                }
            });

            return data;

        } catch (error) {
            notifications.error('Search failed');
            throw error;
        }
    }

    /**
     * Clear cache
     */
    clearCache() {
        this.cache.clear();
    }

    /**
     * Clear cache entry for specific user
     * @param {number} id - User ID
     */
    clearCacheEntry(id) {
        this.cache.delete(id);
    }
}

// Create and export singleton instance
export const users = new Users();

export default users;
