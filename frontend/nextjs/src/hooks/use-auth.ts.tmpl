// hooks/use-auth.ts - Authentication Hook
// Author: {{AUTHOR}}
// Project: {{PROJECT_NAME}}

'use client';

import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
import { useRouter } from 'next/navigation';
import { api, ApiClientError } from '@/lib/api';

interface User {
  id: number;
  email: string;
  username: string;
  full_name: string | null;
  is_active: boolean;
  is_verified: boolean;
}

interface LoginCredentials {
  username: string;
  password: string;
}

interface RegisterData {
  email: string;
  username: string;
  password: string;
  full_name?: string;
}

interface TokenResponse {
  access_token: string;
  refresh_token: string;
  token_type: string;
  expires_in: number;
}

const AUTH_QUERY_KEY = ['auth', 'user'];

export function useAuth() {
  const queryClient = useQueryClient();
  const router = useRouter();

  // Get current user
  const {
    data: user,
    isLoading,
    error,
  } = useQuery<User, ApiClientError>({
    queryKey: AUTH_QUERY_KEY,
    queryFn: () => api.get<User>('/users/me'),
    retry: false,
    enabled: typeof window !== 'undefined' && !!localStorage.getItem('access_token'),
  });

  // Login mutation
  const loginMutation = useMutation<TokenResponse, ApiClientError, LoginCredentials>({
    mutationFn: async (credentials) => {
      // OAuth2 form data format
      const formData = new URLSearchParams();
      formData.append('username', credentials.username);
      formData.append('password', credentials.password);

      const response = await fetch(
        `${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/auth/login`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: formData,
        }
      );

      if (!response.ok) {
        const error = await response.json();
        throw new ApiClientError(
          response.status,
          error.error_code || 'LOGIN_FAILED',
          error.message || 'Login failed'
        );
      }

      return response.json();
    },
    onSuccess: (data) => {
      localStorage.setItem('access_token', data.access_token);
      localStorage.setItem('refresh_token', data.refresh_token);
      queryClient.invalidateQueries({ queryKey: AUTH_QUERY_KEY });
      router.push('/dashboard');
    },
  });

  // Register mutation
  const registerMutation = useMutation<User, ApiClientError, RegisterData>({
    mutationFn: (data) => api.post<User>('/auth/register', data),
    onSuccess: () => {
      router.push('/login?registered=true');
    },
  });

  // Logout function
  const logout = () => {
    localStorage.removeItem('access_token');
    localStorage.removeItem('refresh_token');
    queryClient.clear();
    router.push('/login');
  };

  return {
    user,
    isLoading,
    isAuthenticated: !!user,
    error,
    login: loginMutation.mutate,
    loginAsync: loginMutation.mutateAsync,
    isLoggingIn: loginMutation.isPending,
    loginError: loginMutation.error,
    register: registerMutation.mutate,
    registerAsync: registerMutation.mutateAsync,
    isRegistering: registerMutation.isPending,
    registerError: registerMutation.error,
    logout,
  };
}
