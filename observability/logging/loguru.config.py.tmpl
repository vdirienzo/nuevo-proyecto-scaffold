"""
Loguru Logger Configuration for Python
Project: {{PROJECT_NAME}}
Author: {{AUTHOR}}
"""

import sys
import os
from loguru import logger
from pathlib import Path

# Configuration
LOG_LEVEL = os.getenv("LOG_LEVEL", "INFO")
LOG_DIR = Path("logs")
LOG_DIR.mkdir(exist_ok=True)

# Remove default handler
logger.remove()

# Console handler (development)
if os.getenv("ENVIRONMENT") == "development":
    logger.add(
        sys.stderr,
        level=LOG_LEVEL,
        format="<green>{time:YYYY-MM-DD HH:mm:ss}</green> | <level>{level: <8}</level> | <cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> - <level>{message}</level>",
        colorize=True,
    )
else:
    # JSON format for production
    logger.add(
        sys.stderr,
        level=LOG_LEVEL,
        format="{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | {name}:{function}:{line} - {message}",
        serialize=True,  # JSON output
    )

# File handler with rotation
logger.add(
    LOG_DIR / "{{PROJECT_NAME}}.log",
    level=LOG_LEVEL,
    rotation="100 MB",
    retention="30 days",
    compression="zip",
    format="{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | {name}:{function}:{line} - {message}",
    enqueue=True,  # Async logging
)

# Error file handler
logger.add(
    LOG_DIR / "{{PROJECT_NAME}}_error.log",
    level="ERROR",
    rotation="100 MB",
    retention="90 days",
    compression="zip",
    format="{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | {name}:{function}:{line} - {message}",
    backtrace=True,
    diagnose=True,
    enqueue=True,
)


# Sanitize sensitive data
def sanitize(record):
    """Remove sensitive data from logs."""
    sensitive_keys = ["password", "token", "secret", "api_key", "authorization"]

    if "extra" in record:
        for key in sensitive_keys:
            if key in record["extra"]:
                record["extra"][key] = "***REDACTED***"

    return record


logger = logger.patch(sanitize)


# Helper functions
def log_request(method: str, path: str, status_code: int, duration: float):
    """Log HTTP request."""
    log_func = logger.info if status_code < 400 else logger.error
    log_func(
        f"{method} {path} {status_code}",
        extra={
            "method": method,
            "path": path,
            "status_code": status_code,
            "duration_ms": duration * 1000,
        }
    )


def log_db_query(operation: str, table: str, duration: float):
    """Log database query."""
    logger.debug(
        f"DB {operation} on {table}",
        extra={
            "operation": operation,
            "table": table,
            "duration_ms": duration * 1000,
        }
    )


def log_exception(exc: Exception, context: dict = None):
    """Log exception with context."""
    logger.exception(
        f"Exception occurred: {exc}",
        extra=context or {}
    )


# Export configured logger
__all__ = ["logger", "log_request", "log_db_query", "log_exception"]
