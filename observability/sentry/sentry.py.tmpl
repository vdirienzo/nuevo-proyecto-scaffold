"""
Sentry Configuration for Python
Project: {{PROJECT_NAME}}
Author: {{AUTHOR}}
"""

import os
import sentry_sdk
from sentry_sdk.integrations.fastapi import FastApiIntegration
from sentry_sdk.integrations.sqlalchemy import SqlalchemyIntegration
from sentry_sdk.integrations.httpx import HttpxIntegration
from sentry_sdk.integrations.logging import LoggingIntegration


def init_sentry():
    """Initialize Sentry SDK."""

    # Don't initialize in development
    if os.getenv("ENVIRONMENT") == "development":
        return

    sentry_sdk.init(
        dsn=os.getenv("SENTRY_DSN"),
        environment=os.getenv("ENVIRONMENT", "development"),
        release=os.getenv("APP_VERSION", "1.0.0"),

        # Performance monitoring
        traces_sample_rate=float(os.getenv("SENTRY_TRACES_SAMPLE_RATE", "0.1")),

        # Profiling
        profiles_sample_rate=float(os.getenv("SENTRY_PROFILES_SAMPLE_RATE", "0.1")),

        # Integrations
        integrations=[
            FastApiIntegration(transaction_style="endpoint"),
            SqlalchemyIntegration(),
            HttpxIntegration(),
            LoggingIntegration(
                level=None,  # Capture all levels
                event_level=None,  # Don't send logs as events by default
            ),
        ],

        # Before send hook
        before_send=before_send_hook,

        # Before breadcrumb hook
        before_breadcrumb=before_breadcrumb_hook,

        # Ignore specific errors
        ignore_errors=[
            KeyboardInterrupt,
            "ConnectionError",
            "TimeoutError",
        ],
    )


def before_send_hook(event, hint):
    """Filter and modify events before sending to Sentry."""

    # Remove sensitive data
    if "request" in event:
        if "cookies" in event["request"]:
            del event["request"]["cookies"]

        if "headers" in event["request"]:
            sensitive_headers = ["authorization", "cookie", "x-api-key"]
            for header in sensitive_headers:
                if header in event["request"]["headers"]:
                    event["request"]["headers"][header] = "[Filtered]"

    # Remove sensitive context
    if "contexts" in event:
        if "user" in event["contexts"]:
            if "email" in event["contexts"]["user"]:
                del event["contexts"]["user"]["email"]

    return event


def before_breadcrumb_hook(crumb, hint):
    """Filter breadcrumbs before adding to event."""

    # Ignore health check requests
    if crumb.get("category") == "httplib" and "/health" in crumb.get("data", {}).get("url", ""):
        return None

    # Ignore database queries in breadcrumbs (too verbose)
    if crumb.get("category") == "query":
        return None

    return crumb


def capture_exception(error: Exception, **kwargs):
    """Capture exception with additional context."""
    sentry_sdk.capture_exception(error, **kwargs)


def capture_message(message: str, level: str = "info", **kwargs):
    """Capture message with level."""
    sentry_sdk.capture_message(message, level=level, **kwargs)


def set_user(user_id: str = None, username: str = None, **kwargs):
    """Set user context."""
    sentry_sdk.set_user({
        "id": user_id,
        "username": username,
        **kwargs
    })


def set_context(name: str, context: dict):
    """Set custom context."""
    sentry_sdk.set_context(name, context)


def add_breadcrumb(category: str, message: str, level: str = "info", **data):
    """Add breadcrumb to current scope."""
    sentry_sdk.add_breadcrumb({
        "category": category,
        "message": message,
        "level": level,
        **data
    })
