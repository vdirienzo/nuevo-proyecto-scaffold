"""
OpenTelemetry Tracing Setup for Python
Project: {{PROJECT_NAME}}
Author: {{AUTHOR}}
"""

import os
from opentelemetry import trace, metrics
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor
from opentelemetry.sdk.metrics import MeterProvider
from opentelemetry.sdk.metrics.export import PeriodicExportingMetricReader
from opentelemetry.exporter.otlp.proto.http.trace_exporter import OTLPSpanExporter
from opentelemetry.exporter.otlp.proto.http.metric_exporter import OTLPMetricExporter
from opentelemetry.sdk.resources import Resource, SERVICE_NAME, SERVICE_VERSION, DEPLOYMENT_ENVIRONMENT
from opentelemetry.instrumentation.fastapi import FastAPIInstrumentor
from opentelemetry.instrumentation.httpx import HTTPXClientInstrumentor
from opentelemetry.instrumentation.sqlalchemy import SQLAlchemyInstrumentor

# Resource identification
resource = Resource.create({
    SERVICE_NAME: "{{PROJECT_NAME}}",
    SERVICE_VERSION: os.getenv("APP_VERSION", "1.0.0"),
    DEPLOYMENT_ENVIRONMENT: os.getenv("ENVIRONMENT", "development"),
})

# Trace provider setup
trace_provider = TracerProvider(resource=resource)
otlp_trace_exporter = OTLPSpanExporter(
    endpoint=os.getenv("OTEL_EXPORTER_OTLP_ENDPOINT", "http://localhost:4318/v1/traces")
)
trace_provider.add_span_processor(BatchSpanProcessor(otlp_trace_exporter))
trace.set_tracer_provider(trace_provider)

# Metrics provider setup
metric_reader = PeriodicExportingMetricReader(
    OTLPMetricExporter(
        endpoint=os.getenv("OTEL_EXPORTER_OTLP_ENDPOINT", "http://localhost:4318/v1/metrics")
    ),
    export_interval_millis=10000,
)
meter_provider = MeterProvider(resource=resource, metric_readers=[metric_reader])
metrics.set_meter_provider(meter_provider)

# Get tracer and meter instances
tracer = trace.get_tracer(__name__)
meter = metrics.get_meter(__name__)


def instrument_app(app):
    """
    Instrument FastAPI application with OpenTelemetry.

    Args:
        app: FastAPI application instance
    """
    # Instrument FastAPI
    FastAPIInstrumentor.instrument_app(app)

    # Instrument HTTP client
    HTTPXClientInstrumentor().instrument()

    # Instrument SQLAlchemy (if using)
    # SQLAlchemyInstrumentor().instrument(engine=engine)


def create_counter(name: str, description: str = ""):
    """Create a counter metric."""
    return meter.create_counter(name, description=description)


def create_histogram(name: str, description: str = ""):
    """Create a histogram metric."""
    return meter.create_histogram(name, description=description)


def create_gauge(name: str, description: str = ""):
    """Create a gauge metric."""
    return meter.create_observable_gauge(name, description=description)
