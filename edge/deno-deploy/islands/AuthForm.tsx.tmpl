/**
 * AuthForm.tsx - Authentication form island
 *
 * Author: {{AUTHOR}}
 */

import { signal } from "@preact/signals";

const email = signal("");
const password = signal("");
const error = signal("");
const loading = signal(false);

interface AuthFormProps {
  mode: "login" | "register";
}

export default function AuthForm({ mode }: AuthFormProps) {
  const handleSubmit = async (e: Event) => {
    e.preventDefault();
    error.value = "";
    loading.value = true;

    try {
      const response = await fetch(`/auth/${mode}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email: email.value,
          password: password.value,
        }),
      });

      const data = await response.json();

      if (data.success) {
        localStorage.setItem("token", data.data.token);
        window.location.href = "/dashboard";
      } else {
        error.value = data.error || "Authentication failed";
      }
    } catch (err) {
      error.value = "Network error. Please try again.";
    } finally {
      loading.value = false;
    }
  };

  return (
    <form onSubmit={handleSubmit} class="auth-form">
      <h2>{mode === "login" ? "Login" : "Register"}</h2>

      {error.value && <div class="error">{error.value}</div>}

      <div class="form-group">
        <label for="email">Email</label>
        <input
          id="email"
          type="email"
          value={email.value}
          onInput={(e) => email.value = (e.target as HTMLInputElement).value}
          required
        />
      </div>

      <div class="form-group">
        <label for="password">Password</label>
        <input
          id="password"
          type="password"
          value={password.value}
          onInput={(e) => password.value = (e.target as HTMLInputElement).value}
          required
          minLength={8}
        />
      </div>

      <button type="submit" disabled={loading.value}>
        {loading.value ? "Loading..." : mode === "login" ? "Login" : "Register"}
      </button>

      <p class="switch-mode">
        {mode === "login" ? "Don't have an account?" : "Already have an account?"}
        {" "}
        <a href={mode === "login" ? "/register" : "/login"}>
          {mode === "login" ? "Register" : "Login"}
        </a>
      </p>
    </form>
  );
}
