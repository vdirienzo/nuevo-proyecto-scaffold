/**
 * cache.ts - Caching service using Deno KV
 *
 * Author: {{AUTHOR}}
 */

import { kvService } from "./kv.ts";

const CACHE_PREFIX = "cache:";
const DEFAULT_TTL = 3600 * 1000; // 1 hour in milliseconds

export const cacheService = {
  /**
   * Get cached value
   */
  async get<T>(key: string): Promise<T | null> {
    return await kvService.get<T>(`${CACHE_PREFIX}${key}`);
  },

  /**
   * Set cached value with TTL
   */
  async set<T>(key: string, value: T, ttl: number = DEFAULT_TTL): Promise<void> {
    await kvService.set(`${CACHE_PREFIX}${key}`, value, ttl);
  },

  /**
   * Delete cached value
   */
  async delete(key: string): Promise<void> {
    await kvService.delete(`${CACHE_PREFIX}${key}`);
  },

  /**
   * Get or compute value (cache-aside pattern)
   */
  async getOrSet<T>(
    key: string,
    factory: () => Promise<T>,
    ttl: number = DEFAULT_TTL,
  ): Promise<T> {
    const cached = await this.get<T>(key);
    if (cached !== null) {
      return cached;
    }

    const value = await factory();
    await this.set(key, value, ttl);
    return value;
  },

  /**
   * Clear all cache entries
   */
  async clear(): Promise<void> {
    const entries = await kvService.listByPrefix(CACHE_PREFIX);
    for (const entry of entries) {
      await kvService.delete(entry as string);
    }
  },
};
