#!/usr/bin/env python3
"""
Python Database Seeder
Author: {{AUTHOR}}
Project: {{PROJECT_NAME}}
"""

import asyncio
import json
from pathlib import Path

from faker import Faker
from loguru import logger
from sqlmodel import select
from sqlmodel.ext.asyncio.session import AsyncSession

from src.database import async_session, engine
from src.models import SQLModel, User

fake = Faker()


async def clear_data(session: AsyncSession) -> None:
    """Clear existing data."""
    logger.info("Clearing existing data...")
    await session.exec(select(User).delete())
    await session.commit()


async def seed_users_from_json(session: AsyncSession) -> int:
    """Seed users from JSON file."""
    logger.info("Seeding users from JSON...")

    json_path = Path(__file__).parent / "data" / "users.json"
    with open(json_path) as f:
        users_data = json.load(f)

    count = 0
    for user_data in users_data:
        user = User(**user_data)
        session.add(user)
        count += 1

    await session.commit()
    logger.success(f"Created {count} users from JSON")
    return count


async def seed_random_users(session: AsyncSession, count: int = 10) -> int:
    """Generate random users with Faker."""
    logger.info(f"Generating {count} random users...")

    for _ in range(count):
        user = User(
            email=fake.email(),
            name=fake.name(),
            role=fake.random_element(["user", "admin"]),
        )
        session.add(user)

    await session.commit()
    logger.success(f"Created {count} random users")
    return count


async def main() -> None:
    """Main seed function."""
    logger.info("Starting database seed...")

    # Create tables
    async with engine.begin() as conn:
        await conn.run_sync(SQLModel.metadata.create_all)

    async with async_session() as session:
        # Clear existing data
        await clear_data(session)

        # Seed from JSON
        json_count = await seed_users_from_json(session)

        # Generate random data
        random_count = await seed_random_users(session, count=10)

        # Summary
        total = json_count + random_count
        logger.info("\nSeed Summary:")
        logger.info(f"  Total Users: {total}")
        logger.success("\nSeed completed successfully!")


if __name__ == "__main__":
    asyncio.run(main())
