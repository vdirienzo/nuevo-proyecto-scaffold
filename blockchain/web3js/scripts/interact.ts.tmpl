import { ethers } from "hardhat";
import * as fs from "fs";
import * as path from "path";

/**
 * Interaction script for {{PROJECT_NAME}} contracts
 * @author {{AUTHOR}}
 */

async function main() {
  const [owner] = await ethers.getSigners();
  const network = await ethers.provider.getNetwork();

  console.log("Interacting with contracts as:", owner.address);
  console.log("Network:", network.name);

  // Load deployment info
  const deploymentPath = path.join(
    __dirname,
    "..",
    "deployments",
    `deployment-${network.name}-latest.json`
  );

  if (!fs.existsSync(deploymentPath)) {
    console.error(`No deployment file found for network: ${network.name}`);
    process.exit(1);
  }

  const deployment = JSON.parse(fs.readFileSync(deploymentPath, "utf-8"));

  // Get contract instances
  const token = await ethers.getContractAt(
    "{{PROJECT_NAME}}Token",
    deployment.contracts.Token.address
  );
  const nft = await ethers.getContractAt(
    "{{PROJECT_NAME}}NFT",
    deployment.contracts.NFT.address
  );
  const marketplace = await ethers.getContractAt(
    "{{PROJECT_NAME}}Marketplace",
    deployment.contracts.Marketplace.address
  );

  console.log("\n--- Token Information ---");
  const tokenName = await token.name();
  const tokenSymbol = await token.symbol();
  const tokenSupply = await token.totalSupply();
  const ownerBalance = await token.balanceOf(owner.address);

  console.log("Name:", tokenName);
  console.log("Symbol:", tokenSymbol);
  console.log("Total Supply:", ethers.formatEther(tokenSupply));
  console.log("Owner Balance:", ethers.formatEther(ownerBalance));

  console.log("\n--- NFT Information ---");
  const nftName = await nft.name();
  const nftSymbol = await nft.symbol();
  const maxSupply = await nft.maxSupply();
  const mintPrice = await nft.mintPrice();
  const totalMinted = await nft.totalMinted();

  console.log("Name:", nftName);
  console.log("Symbol:", nftSymbol);
  console.log("Max Supply:", maxSupply.toString());
  console.log("Mint Price:", ethers.formatEther(mintPrice), "ETH");
  console.log("Total Minted:", totalMinted.toString());

  console.log("\n--- Marketplace Information ---");
  const feePercent = await marketplace.feePercent();
  const listingCounter = await marketplace.listingCounter();

  console.log("Fee Percent:", (Number(feePercent) / 100).toFixed(2), "%");
  console.log("Total Listings:", listingCounter.toString());

  // Example: Mint an NFT
  console.log("\n--- Example: Minting NFT ---");
  const tokenURI = "ipfs://QmExample123456789";
  console.log("Minting NFT with URI:", tokenURI);

  const mintTx = await nft.mint(owner.address, tokenURI, {
    value: mintPrice,
  });
  console.log("Transaction hash:", mintTx.hash);

  const receipt = await mintTx.wait();
  console.log("Transaction confirmed in block:", receipt?.blockNumber);

  const newTotalMinted = await nft.totalMinted();
  console.log("New Total Minted:", newTotalMinted.toString());

  // Example: Transfer tokens
  console.log("\n--- Example: Token Transfer ---");
  const transferAmount = ethers.parseEther("100");
  const recipient = ethers.Wallet.createRandom().address;

  console.log("Transferring", ethers.formatEther(transferAmount), "tokens to", recipient);

  const transferTx = await token.transfer(recipient, transferAmount);
  console.log("Transaction hash:", transferTx.hash);

  await transferTx.wait();
  console.log("Transfer confirmed");

  const recipientBalance = await token.balanceOf(recipient);
  console.log("Recipient balance:", ethers.formatEther(recipientBalance));

  console.log("\n--- Interaction Complete ---");
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
